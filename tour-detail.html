<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Details - Cycle Tuscany</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="tailwind.config.js"></script>
    <script type="module" src="site-header.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Parisienne&display=swap" rel="stylesheet">
</head>
<body class="font-sans bg-white text-primary">
    <script>
        let currentTourData = null; 
        let nextAvailableTourData = null;

        // Moved toggleAccordion to global scope
        function toggleAccordion(headerElement) {
            const accordionContent = headerElement.nextElementSibling;
            if (accordionContent.classList.contains('hidden')) {
                accordionContent.classList.remove('hidden');
                accordionContent.style.maxHeight = '9999px'; 

                const gpxChartElement = accordionContent.querySelector('gpx-elevation-chart');
                if (gpxChartElement && typeof gpxChartElement.redraw === 'function') {
                    setTimeout(() => gpxChartElement.redraw(), 300); 
                }

            } else {
                accordionContent.style.maxHeight = "0";
                setTimeout(() => {
                    accordionContent.classList.add('hidden');
                }, 300);
            }
        }
    </script>

    <site-header></site-header>

    <section class="relative h-[60vh] md:h-[80vh] flex items-end overflow-hidden bg-base-background-secondary">
        <div id="hero-image-container" class="absolute inset-0 w-full h-full">
            </div>
        <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-black/20 to-black/60"></div>
        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 w-full">
            <h1 id="hero-title" class="text-4xl md:text-5xl lg:text-6xl font-light text-white mb-4 tracking-wide"></h1>
            <div id="hero-subtitle" class="flex flex-col md:flex-row md:items-center md:gap-8 text-white text-lg font-light"></div>
            <div id="gallery-button-container" class="absolute bottom-6 right-6 z-20">
                </div>
        </div>
    </section>


    <section id="info-row-section" class="bg-white py-8 border-b border-base-background-secondary">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center text-center md:text-left">
            <div class="mb-4 md:mb-0 text-primary">
                <p class="text-xl font-light" id="info-row-start-location"></p>
                <p class="text-base-content-subtle text-sm" id="info-row-duration"></p>
            </div>
            <div class="text-center md:text-right">
                <span class="text-sm lg:text-base font-light text-gray-900">From</span>
                <span id="info-row-old-price" class="text-lg lg:text-xl font-light text-gray-900 line-through mr-2"></span>
                <span id="info-row-discount-label" class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2"></span>
                <span id="info-row-price" class="text-3xl lg:text-4xl font-light text-accent tracking-wide"></span>
            </div>
            <button onclick="showTourCalendarModal(currentTourData)" class="mt-6 md:mt-0 bg-accent hover:bg-accent-dark text-base-content font-medium py-3 px-6 transition-all duration-300 text-center uppercase tracking-wider text-sm rounded">
                Show Departure Calendar
            </button>
        </div>
    </section>


    <section class="py-16 lg:py-24 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-16">
                <div class="lg:col-span-2">
                    <h2 class="text-3xl lg:text-4xl font-light text-primary mb-6 tracking-wide">Why you'll love this trip</h2>
                    <div id="trip-highlights" class="mb-12"></div>

                    <div id="luxury-section" class="hidden mb-12 border border-base-background-secondary rounded-lg">
                        <div class="p-8">
                            <p class="font-script text-accent text-3xl mb-2">Luxury</p>
                            <h2 class="text-2xl font-light text-primary tracking-wide">This is a Luxury Tour</h2>
                            <p class="text-base-content-subtle font-light mt-2 mb-6">A journey designed for maximum comfort, with selected facilities and unique experiences.</p>
                            
                            <div id="luxury-toggle-container-top">
                                 <button id="luxury-accordion-toggle" class="w-full flex justify-center items-center text-accent font-semibold hover:underline py-2">
                                    <span class="toggle-text">More Details</span>
                                    <span class="toggle-arrow ml-2">‚Üì</span>
                                </button>
                            </div>
                        </div>
                        <div id="luxury-accordion-content" class="hidden px-8 pb-8">
                            <div class="border-t border-base-background-secondary pt-6">
                                <p class="text-base-content-subtle font-light leading-relaxed mb-6">
                                    Ride legendary roads by day, unwind in boutique 5-star hotels by night. Our Luxury Tours combine curated cycling routes, breathtaking landscapes, and refined hospitality.
                                </p>
                                <ul class="space-y-3 font-light text-base-content-subtle">
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">‚úì</span><span><strong>Gourmet Dining:</strong> Savor exquisite meals that refuel your body and delight your senses.</span></li>
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">‚úì</span><span><strong>5-Star Hotels:</strong> Relax and recover in handpicked, high-end accommodations.</span></li>
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">‚úì</span><span><strong>Spa & Wellness:</strong> Enjoy access to relaxing spa moments to rejuvenate after a long day's ride.</span></li>
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">‚úì</span><span><strong>Refined Hospitality:</strong> Experience premium service where every detail is taken care of.</span></li>
                                </ul>
    
                                <div id="luxury-toggle-container-bottom" class="mt-6">
                                     </div>
                            </div>
                        </div>
                    </div>

                    <h2 class="text-3xl lg:text-4xl font-light text-primary mb-6 tracking-wide">Itinerary</h2>
                    <tour-itinerary></tour-itinerary>
                </div>

                <div class="lg:col-span-1">
                    <div class="border border-base-background-secondary bg-white p-8 sticky top-32 rounded">
                        <div class="text-center mb-6">
                            <p id="sidebar-start-top" class="text-3xl lg:text-4xl font-light text-primary mb-2 tracking-wide"></p>
                            <p id="sidebar-duration-top" class="text-lg lg:text-xl font-light text-base-content-subtle"></p>
                        </div>
                        <div class="text-center mb-8">
                            <span class="text-sm lg:text-base font-light text-gray-900">From</span>
                            <span id="sidebar-old-price" class="text-lg lg:text-xl font-light text-gray-900 line-through mr-2"></span>
                            <span id="sidebar-discount-label" class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2"></span>
                            <span id="sidebar-price" class="text-4xl lg:text-5xl font-light text-accent tracking-wide"></span>
                        </div>
                        
                        <div class="space-y-6 mb-8">
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üóìÔ∏è Next Departure:</strong>
                                <span id="sidebar-next-departure" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üö≤ Distance:</strong>
                                <span id="sidebar-distance" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üë• Group Size:</strong>
                                <span id="sidebar-group-size" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üí™ Physical Rating:</strong>
                                <span id="sidebar-rating" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üè® Accommodation:</strong>
                                <span id="sidebar-accommodation" class="text-base-content-subtle font-light"></span>
                            </div>
                             <div class="flex justify-between items-center py-4">
                                <strong class="text-primary font-normal">üöê Transport:</strong>
                                <span id="sidebar-transport" class="text-base-content-subtle font-light text-accent"></span>
                            </div>
                        </div>
                        <button onclick="showTourCalendarModal(currentTourData)" class="w-full bg-accent hover:bg-accent-dark text-base-content font-medium py-4 px-6 transition-colors duration-300 text-center block mb-4 uppercase tracking-wider text-sm rounded">
                            Show Tour Calendar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <similar-tours-section id="similar-tours-section"></similar-tours-section>

    <site-footer></site-footer>

    <div id="tour-calendar-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg p-6 lg:p-8 max-w-6xl w-full max-h-[90vh] overflow-y-auto relative">
            <button onclick="showTourCalendarModal(window.currentTourData)" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl font-semibold">X</button>
            <h3 class="text-2xl font-light text-primary mb-4" id="modal-tour-title">Tour Departures</h3>
            <p class="text-base-content-subtle mb-6" id="modal-tour-duration"></p>

            <tour-calendar-modal-content id="tour-calendar-content"></tour-calendar-modal-content>
        </div>
    </div>

    <tour-image-gallery-modal id="tour-gallery-modal"></tour-image-gallery-modal>


    <script type="module" src="gpx-elevation-chart.js"></script>
    <script type="module" src="tour-itinerary.js"></script>
    <script type="module" src="tours-data.js"></script>
    <script type="module" src="similar-tours-section.js"></script>
    <script type="module" src="tour-calendar-modal-content.js"></script>
    <script type="module" src="tour-image-gallery-modal.js"></script>
    <script type="module" src="site-footer.js"></script>
    <script type="module" src="mailing-list-subscribe.js"></script>
    <script type="module">
        import { fetchCombinedToursData } from './tours-data.js';

        // Reference to the main site header and info row section
        let mainSiteHeader;
        let infoRowSection; 
        let originalHeaderContent = ''; // To store original content of the header

        function markdownListToHtml(text) {
            if (!text) return '';
            
            // Check if the content is already in HTML format
            if (text.includes('<') && text.includes('>')) {
                // It's already HTML, just add some styling to list items if needed
                return text.replace(/<li/g, '<li class="list-disc list-inside text-lg text-base-content-subtle mb-3 font-light"');
            } else {
                // Process markdown list with dash/hyphen prefixes and bold formatting
                // Split by newlines to get each list item
                const lines = text.split('\n').filter(line => line.trim());
                
                // Process each line to handle markdown formatting
                const processedItems = lines.map(line => {
                    // Remove the leading dash/hyphen and trim
                    let content = line.replace(/^\s*-\s*/, '').trim();
                    
                    // Convert bold markdown (**text**) to HTML <strong> tags
                    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    return `<li class="list-disc list-inside text-lg text-base-content-subtle mb-3 font-light">${content}</li>`;
                });
                
                return '<ul>' + processedItems.join('') + '</ul>';
            }
        }

        // Function to calculate duration in days and nights
        function calculateDuration(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            if (isNaN(startDate) || isNaN(endDate)) {
                return 'N/A';
            }
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include start day
            const diffNights = diffDays > 0 ? diffDays - 1 : 0;
            return `${diffDays} days, ${diffNights} nights`;
        }

        // Function to parse price string to a number
        function parsePriceToNumber(priceStr) {
            if (!priceStr) return null;
            // Remove currency symbols, commas, and parse as float
            return parseFloat(priceStr.replace(/[^0-9.,]/g, '').replace(',', '.'));
        }

        // Tour Calendar Modal Toggle Function - Now accepts tourData
        function showTourCalendarModal(tourData) {
            const modal = document.getElementById('tour-calendar-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.body.style.overflow = 'hidden'; // Prevent scrolling background
                // Check if tourData exists before accessing its properties
                if (tourData) {
                    // Pass data to the custom element inside the modal
                    const tourCalendarContent = document.getElementById('tour-calendar-content');
                    if (tourCalendarContent) {
                        tourCalendarContent.referenceTourName = tourData.name; // Pass name to component
                        tourCalendarContent.currentTourId = tourData.Id; // Pass current ID
                    }
                    // Also set general modal title/duration
                    document.getElementById('modal-tour-title').textContent = `${tourData.name} Departures`;
                    document.getElementById('modal-tour-duration').textContent = calculateDuration(tourData.start_date, tourData.end_date);
                } else {
                    // If tourData is null, use currentTourData from global scope
                    if (window.currentTourData) {
                        const tourCalendarContent = document.getElementById('tour-calendar-content');
                        if (tourCalendarContent) {
                            tourCalendarContent.referenceTourName = window.currentTourData.name;
                            tourCalendarContent.currentTourId = window.currentTourData.Id;
                        }
                        document.getElementById('modal-tour-title').textContent = `${window.currentTourData.name} Departures`;
                        document.getElementById('modal-tour-duration').textContent = calculateDuration(window.currentTourData.start_date, window.currentTourData.end_date);
                    } else {
                        console.warn('No tour data available for the calendar modal');
                        document.getElementById('modal-tour-title').textContent = 'Tour Departures';
                        document.getElementById('modal-tour-duration').textContent = '';
                    }
                }
            } else {
                document.body.style.overflow = ''; // Restore scrolling
            }
        }
        // Expose functions to global scope for inline onclick attributes
        window.showTourCalendarModal = showTourCalendarModal; 


        // Sticky Header Logic: Now transforms the main site header
        // Variables infoRowSection, mainSiteHeader, originalHeaderContent already declared globally

        function updateStickyHeader() {
            if (!infoRowSection || !mainSiteHeader || !window.currentTourData || !window.nextAvailableTourData) return; // Use window.currentTourData

            const infoRowRect = infoRowSection.getBoundingClientRect();
            const mainHeaderHeight = mainSiteHeader.offsetHeight; 

            // Check if the infoRowSection has scrolled completely out of view (past the top of the main header)
            if (infoRowRect.top <= mainHeaderHeight) { 
                // If not already in sticky state
                if (mainSiteHeader.dataset.stickyState !== 'active') {
                    // Store original header content if not already stored
                    
                    // Update header content to sticky version
                    mainSiteHeader.innerHTML = `
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div class="flex-grow flex items-center space-x-4">
                                <span class="text-primary font-medium text-lg truncate">${window.currentTourData.name}</span>
                                <span class="text-base-content-subtle text-sm hidden md:inline">${calculateDuration(window.currentTourData.start_date, window.currentTourData.end_date)}</span>
                                <span class="text-base-content-subtle text-sm hidden md:inline">|</span>
                                <span class="text-accent font-medium text-base">Next: ${new Date(window.nextAvailableTourData.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm lg:text-base font-light text-gray-900">From</span>
                                <span class="text-xl lg:text-2xl font-light text-accent tracking-wide">${window.currentTourData.price || ''}</span>
                                <button onclick="showTourCalendarModal(window.currentTourData)" class="bg-accent hover:bg-accent-dark text-base-content font-medium py-2 px-4 transition-colors duration-300 uppercase tracking-wider text-sm rounded">
                                    Show Calendar
                                </button>
                            </div>
                        </div>
                    `;
                    mainSiteHeader.dataset.stickyState = 'active'; // Set a custom data attribute to track state
                }
            } else {
                // If currently in sticky state and scrolled back up
                if (mainSiteHeader.dataset.stickyState === 'active') {
                    mainSiteHeader.innerHTML = originalHeaderContent; // Restore original content
                    delete mainSiteHeader.dataset.stickyState; // Remove sticky state
                }
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tourId = parseInt(urlParams.get('id'), 10);

            infoRowSection = document.getElementById('info-row-section');

            mainSiteHeader = document.getElementById('main-site-header'); 
            // Store original header content immediately on DOMContentLoaded, if header exists
            if (mainSiteHeader) {
                originalHeaderContent = mainSiteHeader.innerHTML;
            } else {
                originalHeaderContent = '';
            }

            if (!tourId) {
                document.getElementById('hero-title').textContent = "Tour not found";
                return;
            }

            const allTours = await fetchCombinedToursData();
            console.log('All Tours fetched by tour-detail:', allTours); 
            
            const tour = allTours.find(t => t.Id === tourId);
            console.log('Current Tour Object for Tour Detail Page:', tour); 

            if (tour) {
                window.currentTourData = tour; // Assign to global variable

                document.title = `Tour Details - ${tour.name}`;
                document.getElementById('hero-title').textContent = tour.name;
                const heroImageContainer = document.getElementById('hero-image-container');
                const galleryButtonContainer = document.getElementById('gallery-button-container');

                let galleryImages = [];
                try {
                    // Safely parse gallery_images, ensuring it's an array and not null/empty
                    if (tour.gallery_images && typeof tour.gallery_images === 'string') {
                        const parsed = JSON.parse(tour.gallery_images);
                        if (Array.isArray(parsed)) {
                            galleryImages = parsed;
                        }
                    } else if (Array.isArray(tour.gallery_images)) {
                        // If it's already an array (e.g., from NocoDB's internal handling)
                        galleryImages = tour.gallery_images;
                    }
                } catch (e) {
                    console.error("Error parsing gallery_images:", e);
                    galleryImages = []; // Fallback to empty array if parsing fails
                }

                // --- Original mosaic/single image layout logic restored ---
                if (!galleryImages || galleryImages.length < 3) { // Need at least 3 for the smaller grid
                    heroImageContainer.innerHTML = `
                        <img id="hero-image" src="${tour.image || ''}" class="w-full h-full object-cover" alt="Tour hero image">
                    `;
                } else {
                    // Construct the mosaic layout
                    heroImageContainer.innerHTML = `
                        <div class="grid grid-cols-3 grid-rows-2 h-full gap-0.5">
                            <img src="${tour.image || ''}" alt="Main tour image" class="col-span-2 row-span-2 w-full h-full object-cover">
                            <img src="${galleryImages[0] || ''}" alt="Gallery image 1" class="col-span-1 row-span-1 w-full h-full object-cover">
                            <img src="${galleryImages[1] || ''}" alt="Gallery image 2" class="col-span-1 row-span-1 w-full h-full object-cover">
                        </div>
                    `;
                }
                // --- End of original layout logic ---


                // Always add a button to open the full gallery modal
                const totalImagesCount = (tour.image ? 1 : 0) + galleryImages.length;
                galleryButtonContainer.innerHTML = `
                    <button id="open-gallery-btn" class="bg-black/50 text-white text-sm font-medium px-4 py-2 rounded-full hover:bg-black/70 transition-colors">
                        See all ${totalImagesCount} photos
                    </button>
                `;

                // Get reference to the modal and set up click listener for the new button
                const tourGalleryModal = document.getElementById('tour-gallery-modal');
                const openGalleryBtn = document.getElementById('open-gallery-btn');
                if (openGalleryBtn && tourGalleryModal) {
                    openGalleryBtn.addEventListener('click', () => {
                        tourGalleryModal.tourId = tour.Id;
                        tourGalleryModal.allToursData = allTours; // Pass the entire dataset
                        tourGalleryModal.isOpen = true;
                        console.log('Open Gallery Button clicked. tourGalleryModal.isOpen:', tourGalleryModal.isOpen);
                        console.log('tourGalleryModal.tourId:', tourGalleryModal.tourId);
                        console.log('tourGalleryModal.allToursData assigned.');
                    });
                }

                // --- Add event listener to heroImageContainer to open gallery modal on image click ---
                if (heroImageContainer && tourGalleryModal) {
                    heroImageContainer.addEventListener('click', (event) => {
                        // Check if the click was directly on an image within the container
                        if (event.target.tagName === 'IMG') {
                            tourGalleryModal.tourId = tour.Id;
                            tourGalleryModal.allToursData = allTours; // Pass the entire dataset
                            tourGalleryModal.isOpen = true;
                            console.log('Hero Image clicked. tourGalleryModal.isOpen:', tourGalleryModal.isOpen);
                            console.log('tourGalleryModal.tourId:', tourGalleryModal.tourId);
                            console.log('tourGalleryModal.allToursData assigned.');
                        }
                    });
                }
                // --- End of new image click listener ---


                document.getElementById('hero-title').textContent = tour.name;
                document.getElementById('hero-subtitle').innerHTML = `
                    <span>${calculateDuration(tour.start_date, tour.end_date)}</span>
                    <span class="hidden md:inline">‚Ä¢</span>
                    <span>${tour.description || ''}</span>
                `;

                // Set content for the new top info row
                document.getElementById('info-row-start-location').textContent = tour.start_location || 'N/A';
                document.getElementById('info-row-duration').textContent = calculateDuration(tour.start_date, tour.end_date);
                
                const currentPrice = parsePriceToNumber(tour.price);
                const oldPrice = parsePriceToNumber(tour.old_price);

                if (tour.price) {
                    document.getElementById('info-row-price').textContent = tour.price;
                } else {
                     document.getElementById('info-row-price').textContent = '';
                }

                if (oldPrice && currentPrice && oldPrice > currentPrice) {
                    document.getElementById('info-row-old-price').textContent = tour.old_price;
                    const discountPercentage = ((oldPrice - currentPrice) / oldPrice) * 100;
                    document.getElementById('info-row-discount-label').textContent = `Save ${Math.round(discountPercentage)}%`;
                } else {
                    document.getElementById('info-row-old-price').textContent = '';
                    document.getElementById('info-row-discount-label').textContent = '';
                }


                // Set content for the sidebar
                document.getElementById('sidebar-start-top').textContent = tour.start_location || 'N/A';
                document.getElementById('sidebar-duration-top').textContent = calculateDuration(tour.start_date, tour.end_date);
                
                if (tour.price) {
                    document.getElementById('sidebar-price').textContent = tour.price;
                } else {
                     document.getElementById('sidebar-price').textContent = '';
                }

                if (oldPrice && currentPrice && oldPrice > currentPrice) {
                    document.getElementById('sidebar-old-price').textContent = tour.old_price;
                    const discountPercentage = ((oldPrice - currentPrice) / oldPrice) * 100;
                    document.getElementById('sidebar-discount-label').textContent = `Save ${Math.round(discountPercentage)}%`;
                } else {
                    document.getElementById('sidebar-old-price').textContent = '';
                    document.getElementById('sidebar-discount-label').textContent = '';
                }

                document.getElementById('sidebar-distance').textContent = tour.total_distance_km ? `${tour.total_distance_km} km` : '';
                document.getElementById('sidebar-group-size').textContent = tour.group_size_max ? `Max ${tour.group_size_max}` : '';
                document.getElementById('sidebar-rating').textContent = tour.physical_rating || '';
                document.getElementById('sidebar-transport').textContent = tour.transport || '';
                // Accommodation re-added
                document.getElementById('sidebar-accommodation').textContent = tour.accommodation || '';
                // Transport icon color is handled by Tailwind class on the element itself in HTML

                const highlightsContainer = document.getElementById('trip-highlights');
                if (highlightsContainer && tour.trip_highlights) {
                    highlightsContainer.innerHTML = markdownListToHtml(tour.trip_highlights);
                }

                // Show luxury accordion if tour type is 'luxury'
                if (tour.type === 'luxury') {
                    const luxurySection = document.getElementById('luxury-section');
                    if (luxurySection) {
                        luxurySection.classList.remove('hidden');
                    }
                }

                const itineraryComponent = document.querySelector('tour-itinerary');
                if (itineraryComponent) {
                    itineraryComponent.itinerary = tour.itinerary;
                }

                // Find and display next departure (from today onwards, including sold out)
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
                
                window.nextAvailableTourData = allTours.filter(t => // Assign to global variable
                    t.name === tour.name && 
                    new Date(t.start_date) >= today 
                ).sort((a, b) => new Date(a.start_date) - new Date(b.start_date))[0]; 

                const nextDepartureElement = document.getElementById('sidebar-next-departure');
                if (nextDepartureElement) {
                    if (window.nextAvailableTourData) { // Use global variable
                        const nextStartDate = new Date(window.nextAvailableTourData.start_date);
                        const options = { year: 'numeric', month: 'long', day: 'numeric' };
                        nextDepartureElement.textContent = nextStartDate.toLocaleDateString('en-US', options);
                    } else {
                        nextDepartureElement.textContent = 'No upcoming departures';
                    }
                }

                // Pass all relevant tours data to similar-tours-section for internal filtering
                const similarToursSection = document.getElementById('similar-tours-section');
                if (similarToursSection) {
                    similarToursSection.tours = allTours; // Pass all tours, let component filter by name and date
                    similarToursSection.referenceTourName = tour.name;
                    similarToursSection.currentTourId = tour.Id;
                }

                // Initialize sticky header listener after data is loaded
                window.addEventListener('scroll', updateStickyHeader);
                window.addEventListener('resize', updateStickyHeader); 
                updateStickyHeader(); // Call once to set initial state

                // Luxury Accordion Toggle - Re-added and fixed logic
                const luxuryAccordionToggle = document.getElementById('luxury-accordion-toggle');
                const luxuryContent = document.getElementById('luxury-accordion-content');
                const topContainer = document.getElementById('luxury-toggle-container-top');
                const bottomContainer = document.getElementById('luxury-toggle-container-bottom');

                if (luxuryAccordionToggle && luxuryContent && topContainer && bottomContainer) {
                    // Remove the problematic onclick attribute
                    luxuryAccordionToggle.removeAttribute('onclick');

                    luxuryAccordionToggle.addEventListener('click', () => {
                        const text = luxuryAccordionToggle.querySelector('.toggle-text');
                        const arrow = luxuryAccordionToggle.querySelector('.toggle-arrow');
                        
                        const isCurrentlyHidden = luxuryContent.classList.contains('hidden');
                        
                        if (isCurrentlyHidden) {
                            luxuryContent.classList.remove('hidden');
                            luxuryContent.style.maxHeight = '9999px'; // For smooth transition
                            bottomContainer.appendChild(luxuryAccordionToggle);
                            text.textContent = 'Less Details';
                            arrow.textContent = '‚Üë';
                        } else {
                            luxuryContent.style.maxHeight = '0'; // For smooth transition
                            setTimeout(() => { // Add hidden after transition
                                luxuryContent.classList.add('hidden');
                            }, 300); // Should match CSS transition duration
                            topContainer.appendChild(luxuryAccordionToggle);
                            text.textContent = 'More Details';
                            arrow.textContent = '‚Üì';
                        }
                    });
                }

            } else {
                document.getElementById('hero-title').textContent = "Tour not found";
            }
        });
    </script>
</body>
</html>