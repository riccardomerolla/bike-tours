<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Details - Cycle Tuscany</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="tailwind.config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Parisienne&display=swap" rel="stylesheet">
</head>
<body class="font-sans bg-white text-primary">
    <header class="bg-white border-b border-base-background-secondary sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16 lg:h-20">
                <a href="index.html" class="text-2xl lg:text-3xl font-light text-black tracking-wide">BikeTours</a>
                <button id="mobile-menu-btn" class="md:hidden p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <nav class="hidden md:flex space-x-10">
                    <a href="tours.html" class="text-primary hover:text-accent font-normal transition-colors uppercase tracking-wider text-sm">Tours</a>
                    <a href="about.html" class="text-primary hover:text-accent font-normal transition-colors uppercase tracking-wider text-sm">About</a>
                    <a href="#" class="text-primary hover:text-accent font-normal transition-colors uppercase tracking-wider text-sm">Contact</a>
                </nav>
            </div>
            <div id="mobile-menu" class="hidden md:hidden pb-4">
                <div class="flex flex-col space-y-4">
                    <a href="tours.html" class="text-primary hover:text-accent font-normal uppercase tracking-wider text-sm">Tours</a>
                    <a href="about.html" class="text-primary hover:text-accent font-normal uppercase tracking-wider text-sm">About</a>
                    <a href="#" class="text-primary hover:text-accent font-normal uppercase tracking-wider text-sm">Contact</a>
                </div>
            </div>
        </div>
    </header>

    <section class="relative h-[60vh] flex items-end overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-black/20 to-black/60">
            <img id="hero-image" src="" class="w-full h-full object-cover" alt="Tour hero image">
        </div>
        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 w-full">
            <h1 id="hero-title" class="text-4xl md:text-5xl lg:text-6xl font-light text-white mb-4 tracking-wide"></h1>
            <div id="hero-subtitle" class="flex flex-col md:flex-row md:items-center md:gap-8 text-white text-lg font-light"></div>
        </div>
    </section>

    <section class="py-16 lg:py-24 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-16">
                <div class="lg:col-span-2">
                    <h2 class="text-3xl lg:text-4xl font-light text-primary mb-6 tracking-wide">Why you'll love this trip</h2>
                    <div id="trip-highlights" class="mb-12"></div>

                    <h2 class="text-3xl lg:text-4xl font-light text-primary mb-6 tracking-wide">Itinerary</h2>
                    <tour-itinerary></tour-itinerary>
                </div>

                <div class="lg:col-span-1">
                    <div class="border border-base-background-secondary bg-white p-8 sticky top-32 rounded">
                        <h3 id="sidebar-price" class="text-2xl lg:text-3xl font-light text-primary mb-6 tracking-wide"></h3>
                        <div class="space-y-6 mb-8">
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üìÖ Duration:</strong>
                                <span id="sidebar-duration" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üö≤ Distance:</strong>
                                <span id="sidebar-distance" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üë• Group Size:</strong>
                                <span id="sidebar-group-size" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üí™ Physical Rating:</strong>
                                <span id="sidebar-rating" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üö© Start:</strong>
                                <span id="sidebar-start" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üèÅ End:</strong>
                                <span id="sidebar-end" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üçΩÔ∏è Meals:</strong>
                                <span id="sidebar-meals" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">üè® Accommodation:</strong>
                                <span id="sidebar-accommodation" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4">
                                <strong class="text-primary font-normal">üö≤ Transport:</strong>
                                <span id="sidebar-transport" class="text-base-content-subtle font-light"></span>
                            </div>
                        </div>
                        <a href="#" class="w-full bg-accent hover:bg-accent-dark text-black font-medium py-4 px-6 transition-colors duration-300 text-center block mb-4 uppercase tracking-wider text-sm rounded">
                            Book This Tour
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <similar-tours-section></similar-tours-section>

    <script type="module" src="gpx-elevation-chart.js"></script>
    <script type="module" src="tour-itinerary.js"></script>
    <script type="module" src="similar-tours-section.js"></script>

    <script>
        // --- RESTORED SCRIPT BLOCK ---
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Accordion Toggle Functionality
        function toggleAccordion(headerElement) {
            const accordionContent = headerElement.nextElementSibling;
            if (accordionContent.classList.contains('hidden')) {
                accordionContent.classList.remove('hidden');
                accordionContent.style.maxHeight = '9999px'; 

                const gpxChartElement = accordionContent.querySelector('gpx-elevation-chart');
                if (gpxChartElement && typeof gpxChartElement.redraw === 'function') {
                    setTimeout(() => gpxChartElement.redraw(), 300); 
                }

            } else {
                accordionContent.style.maxHeight = "0";
                setTimeout(() => {
                    accordionContent.classList.add('hidden');
                }, 300);
            }
        }
    </script>

    <script type="module">
        import { fetchCombinedToursData } from './tours-data.js';

        function markdownListToHtml(text) {
            if (!text) return '';
            const listItems = text.split('*').map(item => item.trim()).filter(item => item);
            return '<ul>' + listItems.map(item => `<li class="list-disc list-inside text-lg text-base-content-subtle mb-3 font-light">${item}</li>`).join('') + '</ul>';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tourId = parseInt(urlParams.get('id'), 10);

            if (!tourId) {
                document.getElementById('hero-title').textContent = "Tour not found";
                return;
            }

            const allTours = await fetchCombinedToursData();
            const currentTour = allTours.find(t => t.Id === tourId);

            if (currentTour) {
                // This part that sets up the page content remains the same
                document.title = `Tour Details - ${currentTour.name}`;
                document.getElementById('hero-title').textContent = currentTour.name;
                document.getElementById('hero-image').src = currentTour.image || '';
                document.getElementById('hero-subtitle').innerHTML = `
                    <span>${currentTour.duration_days || 'N/A'} days</span>
                    <span class="hidden md:inline">‚Ä¢</span>
                    <span>${currentTour.description || ''}</span>
                `;
                document.getElementById('sidebar-price').textContent = currentTour.price ? `From ${currentTour.price}` : '';
                document.getElementById('sidebar-duration').textContent = currentTour.duration_days ? `${currentTour.duration_days} Days` : '';
                document.getElementById('sidebar-distance').textContent = currentTour.total_distance_km ? `${currentTour.total_distance_km} km` : '';
                document.getElementById('sidebar-group-size').textContent = currentTour.group_size_max ? `Max ${currentTour.group_size_max}` : '';
                document.getElementById('sidebar-rating').textContent = currentTour.physical_rating || '';
                document.getElementById('sidebar-start').textContent = currentTour.start_location || '';
                document.getElementById('sidebar-end').textContent = currentTour.end_location || '';
                document.getElementById('sidebar-meals').textContent = currentTour.meals_summary || '';
                document.getElementById('sidebar-accommodation').textContent = currentTour.accommodation || '';
                document.getElementById('sidebar-transport').textContent = currentTour.transport || '';
                const highlightsContainer = document.getElementById('trip-highlights');
                if (highlightsContainer && currentTour.trip_highlights) {
                    highlightsContainer.innerHTML = markdownListToHtml(currentTour.trip_highlights);
                }
                const itineraryComponent = document.querySelector('tour-itinerary');
                if (itineraryComponent) {
                    itineraryComponent.itinerary = currentTour.itinerary;
                }

                // --- CORRECTED FILTER LOGIC ---
                const similarToursSection = document.querySelector('similar-tours-section');
                if (similarToursSection) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const availableTours = allTours.filter(tour => {
                        // Condition 1: Only include tours with the same name.
                        if (tour.name === currentTour.name) {
                            const tourEndDate = new Date(tour.end_date);
                            
                            // Handle cases with invalid dates.
                            if (isNaN(tourEndDate)) {
                                return false;
                            }

                            // Condition 2: Include the tour if it's the one being viewed (for context)
                            // AND if it's a future departure.
                            return tour.Id === currentTour.Id || tourEndDate >= today;
                        }
                        // If the name doesn't match, exclude it.
                        return false;
                    });
                    
                    similarToursSection.tours = availableTours;
                }
            } else {
                document.getElementById('hero-title').textContent = "Tour not found";
            }
        });
    </script>
</body>
</html>