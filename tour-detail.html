<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Details - Cycle Tuscany</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="tailwind.config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Parisienne&display=swap" rel="stylesheet">
</head>
<body class="font-sans bg-white text-primary">
    <header class="bg-white border-b border-base-background-secondary sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16 lg:h-20">
                <a href="index.html" class="flex items-center h-12"><img src="img/logo.png" alt="BikeTours.cc" class="h-6 w-auto object-contain"></a>
                <button id="mobile-menu-btn" class="md:hidden p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <nav class="hidden md:flex space-x-10">
                    <a href="tours.html" class="text-primary hover:text-accent font-normal transition-colors uppercase tracking-wider text-sm">Tours</a>
                    <a href="about.html" class="text-primary hover:text-accent font-normal transition-colors uppercase tracking-wider text-sm">About</a>
                    <a href="#" class="text-primary hover:text-accent font-normal transition-colors uppercase tracking-wider text-sm">Contact</a>
                </nav>
            </div>
            <div id="mobile-menu" class="hidden md:hidden pb-4">
                <div class="flex flex-col space-y-4">
                    <a href="tours.html" class="text-primary hover:text-accent font-normal uppercase tracking-wider text-sm">Tours</a>
                    <a href="about.html" class="text-primary hover:text-accent font-normal uppercase tracking-wider text-sm">About</a>
                    <a href="#" class="text-primary hover:text-accent font-normal uppercase tracking-wider text-sm">Contact</a>
                </div>
            </div>
        </div>
    </header>

    <section class="relative h-[60vh] flex items-end overflow-hidden">
        <div class="absolute inset-0">
             <img id="hero-image" src="" class="w-full h-full object-cover" alt="Tour hero image">
            <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-black/20 to-black/60"></div>
        </div>
        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 w-full">
            <h1 id="hero-title" class="text-4xl md:text-5xl lg:text-6xl font-light text-white mb-4 tracking-wide"></h1>
            <div id="hero-subtitle" class="flex flex-col md:flex-row md:items-center md:gap-8 text-white text-lg font-light"></div>
        </div>
    </section>

    <section class="py-16 lg:py-24 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-16">
                <div class="lg:col-span-2">
                    <h2 class="text-3xl lg:text-4xl font-light text-primary mb-6 tracking-wide">Why you'll love this trip</h2>
                    <div id="trip-highlights" class="mb-12"></div>

                    <div id="luxury-section" class="hidden mb-12 border border-base-background-secondary rounded-lg">
                        <div class="p-8">
                            <p class="font-script text-accent text-3xl mb-2">Luxury</p>
                            <h2 class="text-2xl font-light text-primary tracking-wide">This is a Luxury Tour</h2>
                            <p class="text-base-content-subtle font-light mt-2 mb-6">AA journey designed for maximum comfort, with selected facilities and unique experiences.</p>
                            
                            <div id="luxury-toggle-container-top">
                                 <button id="luxury-accordion-toggle" class="w-full flex justify-center items-center text-accent font-semibold hover:underline py-2">
                                    <span class="toggle-text">More Details</span>
                                    <span class="toggle-arrow ml-2">↓</span>
                                </button>
                            </div>
                        </div>
                        <div id="luxury-accordion-content" class="hidden px-8 pb-8">
                            <div class="border-t border-base-background-secondary pt-6">
                                <p class="text-base-content-subtle font-light leading-relaxed mb-6">
                                    Ride legendary roads by day, unwind in boutique 5-star hotels by night. Our Luxury Tours combine curated cycling routes, breathtaking landscapes, and refined hospitality.
                                </p>
                                <ul class="space-y-3 font-light text-base-content-subtle">
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">✓</span><span><strong>Gourmet Dining:</strong> Savor exquisite meals that refuel your body and delight your senses.</span></li>
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">✓</span><span><strong>5-Star Hotels:</strong> Relax and recover in handpicked, high-end accommodations.</span></li>
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">✓</span><span><strong>Spa & Wellness:</strong> Enjoy access to relaxing spa moments to rejuvenate after a long day's ride.</span></li>
                                    <li class="flex items-start"><span class="text-accent mr-3 mt-1">✓</span><span><strong>Refined Hospitality:</strong> Experience premium service where every detail is taken care of.</span></li>
                                </ul>
    
                                <div id="luxury-toggle-container-bottom" class="mt-6">
                                     </div>
                            </div>
                        </div>
                    </div>

                    <h2 class="text-3xl lg:text-4xl font-light text-primary mb-6 tracking-wide">Itinerary</h2>
                    <tour-itinerary></tour-itinerary>
                </div>

                <div class="lg:col-span-1">
                    <div class="border border-base-background-secondary bg-white p-8 sticky top-32 rounded">
                        <h3 id="sidebar-price" class="text-2xl lg:text-3xl font-light text-primary mb-6 tracking-wide"></h3>
                        <div class="space-y-6 mb-8">
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">📅 Duration:</strong>
                                <span id="sidebar-duration" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">🗓️ Next Departure:</strong>
                                <span id="sidebar-next-departure" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">🚲 Distance:</strong>
                                <span id="sidebar-distance" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">👥 Group Size:</strong>
                                <span id="sidebar-group-size" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">💪 Physical Rating:</strong>
                                <span id="sidebar-rating" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">🚩 Start:</strong>
                                <span id="sidebar-start" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">🏁 End:</strong>
                                <span id="sidebar-end" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">🍽️ Meals:</strong>
                                <span id="sidebar-meals" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4 border-b border-base-background-secondary">
                                <strong class="text-primary font-normal">🏨 Accommodation:</strong>
                                <span id="sidebar-accommodation" class="text-base-content-subtle font-light"></span>
                            </div>
                            <div class="flex justify-between items-center py-4">
                                <strong class="text-primary font-normal">🚐 Transport:</strong>
                                <span id="sidebar-transport" class="text-base-content-subtle font-light"></span>
                            </div>
                        </div>
                        <a href="#" class="w-full bg-accent hover:bg-accent-dark text-black font-medium py-4 px-6 transition-colors duration-300 text-center block mb-4 uppercase tracking-wider text-sm rounded">
                            Book This Tour
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <similar-tours-section id="similar-tours-section"></similar-tours-section>

    <div id="footer-placeholder"></div>

    <script src="main.js"></script>

    <script type="module" src="gpx-elevation-chart.js"></script>
    <script type="module" src="tour-itinerary.js"></script>
    <script type="module" src="tours-data.js"></script>
    <script type="module" src="similar-tours-section.js"></script>

    <script>
        // --- SCRIPT BLOCK ---
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Accordion Toggle Functionality (for Itinerary)
        function toggleAccordion(headerElement) {
            const accordionContent = headerElement.nextElementSibling;
            if (accordionContent.classList.contains('hidden')) {
                accordionContent.classList.remove('hidden');
                accordionContent.style.maxHeight = '9999px'; 

                const gpxChartElement = accordionContent.querySelector('gpx-elevation-chart');
                if (gpxChartElement && typeof gpxChartElement.redraw === 'function') {
                    setTimeout(() => gpxChartElement.redraw(), 300); 
                }

            } else {
                accordionContent.style.maxHeight = "0";
                setTimeout(() => {
                    accordionContent.classList.add('hidden');
                }, 300);
            }
        }

        // Luxury Accordion Toggle
        const luxuryAccordionToggle = document.getElementById('luxury-accordion-toggle');
        const luxuryContent = document.getElementById('luxury-accordion-content');
        const topContainer = document.getElementById('luxury-toggle-container-top');
        const bottomContainer = document.getElementById('luxury-toggle-container-bottom');

        if (luxuryAccordionToggle && luxuryContent && topContainer && bottomContainer) {
            luxuryAccordionToggle.addEventListener('click', () => {
                const text = luxuryAccordionToggle.querySelector('.toggle-text');
                const arrow = luxuryAccordionToggle.querySelector('.toggle-arrow');
                
                const isCurrentlyHidden = luxuryContent.classList.contains('hidden');
                
                if (isCurrentlyHidden) {
                    // Content is hidden, so EXPAND it.
                    luxuryContent.classList.remove('hidden');
                    // Move button to the bottom container.
                    bottomContainer.appendChild(luxuryAccordionToggle);
                    // Update text to "Less Details".
                    text.textContent = 'Less Details';
                    arrow.textContent = '↑';
                } else {
                    // Content is visible, so COLLAPSE it.
                    luxuryContent.classList.add('hidden');
                    // Move button back to the top container.
                    topContainer.appendChild(luxuryAccordionToggle);
                    // Update text to "More Details".
                    text.textContent = 'More Details';
                    arrow.textContent = '↓';
                }
            });
        }
    </script>

    <script type="module">
        import { fetchCombinedToursData } from './tours-data.js';

        function markdownListToHtml(text) {
            if (!text) return '';
            const listItems = text.split('*').map(item => item.trim()).filter(item => item);
            return '<ul>' + listItems.map(item => `<li class="list-disc list-inside text-lg text-base-content-subtle mb-3 font-light">${item}</li>`).join('') + '</ul>';
        }

        // Function to calculate duration in days and nights
        function calculateDuration(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            if (isNaN(startDate) || isNaN(endDate)) {
                return 'N/A';
            }
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include start day
            const diffNights = diffDays > 0 ? diffDays - 1 : 0;
            return `${diffDays} days, ${diffNights} nights`;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tourId = parseInt(urlParams.get('id'), 10);

            if (!tourId) {
                document.getElementById('hero-title').textContent = "Tour not found";
                return;
            }

            const allTours = await fetchCombinedToursData();
            const tour = allTours.find(t => t.Id === tourId);

            if (tour) {
                document.title = `Tour Details - ${tour.name}`;
                document.getElementById('hero-title').textContent = tour.name;
                document.getElementById('hero-image').src = tour.image || '';
                document.getElementById('hero-subtitle').innerHTML = `
                    <span>${calculateDuration(tour.start_date, tour.end_date)}</span>
                    <span class="hidden md:inline">•</span>
                    <span>${tour.description || ''}</span>
                `;

                document.getElementById('sidebar-price').textContent = tour.price ? `From ${tour.price}`: '';
                document.getElementById('sidebar-duration').textContent = calculateDuration(tour.start_date, tour.end_date);
                document.getElementById('sidebar-distance').textContent = tour.total_distance_km ? `${tour.total_distance_km} km` : '';
                document.getElementById('sidebar-group-size').textContent = tour.group_size_max ? `Max ${tour.group_size_max}` : '';
                document.getElementById('sidebar-rating').textContent = tour.physical_rating || '';
                document.getElementById('sidebar-start').textContent = tour.start_location || '';
                document.getElementById('sidebar-end').textContent = tour.end_location || '';
                document.getElementById('sidebar-meals').textContent = tour.meals_summary || '';
                document.getElementById('sidebar-accommodation').textContent = tour.accommodation || '';
                document.getElementById('sidebar-transport').textContent = tour.transport || '';
                
                const highlightsContainer = document.getElementById('trip-highlights');
                if (highlightsContainer && tour.trip_highlights) {
                    highlightsContainer.innerHTML = markdownListToHtml(tour.trip_highlights);
                }

                // Show luxury accordion if tour type is 'luxury'
                if (tour.type === 'luxury') {
                    const luxurySection = document.getElementById('luxury-section');
                    if (luxurySection) {
                        luxurySection.classList.remove('hidden');
                    }
                }

                const itineraryComponent = document.querySelector('tour-itinerary');
                if (itineraryComponent) {
                    itineraryComponent.itinerary = tour.itinerary;
                }

                // Find and display next departure (from today onwards, including sold out)
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
                
                const nextAvailableTour = allTours.filter(t => 
                    t.name === tour.name && 
                    new Date(t.start_date) >= today // Check from today onwards
                ).sort((a, b) => new Date(a.start_date) - new Date(b.start_date))[0]; // Get the earliest one

                const nextDepartureElement = document.getElementById('sidebar-next-departure');
                if (nextDepartureElement) {
                    if (nextAvailableTour) {
                        const nextStartDate = new Date(nextAvailableTour.start_date);
                        const options = { year: 'numeric', month: 'long', day: 'numeric' };
                        nextDepartureElement.textContent = nextStartDate.toLocaleDateString('en-US', options);
                    } else {
                        nextDepartureElement.textContent = 'No upcoming departures';
                    }
                }

                // Pass all relevant tours data to similar-tours-section for internal filtering
                const similarToursSection = document.getElementById('similar-tours-section');
                if (similarToursSection) {
                    similarToursSection.tours = allTours; // Pass all tours, let component filter by name and date
                    similarToursSection.referenceTourName = tour.name;
                    similarToursSection.currentTourId = tour.Id;
                }

            } else {
                document.getElementById('hero-title').textContent = "Tour not found";
            }
        });
    </script>
</body>
</html>